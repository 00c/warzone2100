-- Generated by wz2lua (implementation file)
version(0) --- version of the script API this script is written for
numart = 0

-- structure limit stuff
-- public	STRUCTURESTAT		powerModuleHack;

-- Win or lose
allPlayer = Group()
nearLZ = Group()
totDroids = 0

-- Base Under Attack Stuff
hitStruc = nil
attackerObj = nil
t = 0

-- Transport Entry/Exit coords

-- LZ Message

-- Briefing stuff
-- , winMsg;

-- Proximity: Resources
--[[public		FEATURE		res1;
public		INTMESSAGE	res1Msg;
public		SOUND		res1Snd;
public		STRUCTURESTAT	derrick;
private		int		res1x,res1y;	//temp values to cope with oil disappearing!]]--

-- Proximity: Artifacts

-- public		FEATURE		art1Get;
-- public		INTMESSAGE	art1Msg;
-- Heavy Machine Gun
art1ID = nil

--[[public		int		art2X, art2Y;
public		FEATURE		art2Get;
public		SOUND		art2Snd1, art2Snd2;
//public		INTMESSAGE	art2Msg;
public		RESEARCHSTAT	art2Comp;	//Power Module
private		FEATURE		art2ID;]]--

-- player Bonus Research topics given at end of mission
-- need to be declared with value >= numResP0, numResP1, etc.
count = 0


-- Enemy Tactics
enemy1Surprise = Group()
enemy1Last = Group()
enemy1Rear1 = Group()
playerForce1 = Group()
enemy1Last1 = Group()
enemy1Last2 = Group()
playerX1 = 0
playerY1 = 0


-- event wonYetEvnt;
-- event art1SeenEvnt;

-- Events: Start

-- (CALL_GAMEINIT)
function startEvnt()
	removeMessage(InFlight, MISS_MSG, 0)
	centreViewPos(1152, 10752)
	-- set scroll limits
	-- setScrollParams(0, 0, 44, 93);			//limit scroll
	-- set zoom Level 128x128
	setRadarZoom(0)
	-- set up the landing zone
	setLandingZone(8, 83, 10, 85)
	-- call in transport
	flyTransporterIn(player, entryX, entryY, false)
	setTransporterExit(player, exitX, exitY)
	
	-- make sure all buttons available/unavailable
	-- removeReticuleButton(MANUFACTURE);
	-- removeReticuleButton(RESEARCH);
	-- removeReticuleButton(DESIGN);
	-- removeReticuleButton(BUILD);
	-- give player briefing again (stored)
	addMessage(MissionBrief, MISS_MSG, 0, false)
	flashOff(INTELMAP)
	-- Blip Given at start
	addMessage(obj1, PROX_MSG, player, false)
	-- allow to build stuff
	setStructureLimits(powerGen, numPow, 0)
	setStructureLimits(oilDerrick, numExt, 0)
	setStructureLimits(research, numRes, 0)
	setStructureLimits(factory, numFac, 0)
	setStructureLimits(command, 0, player)
	enableStructure(command, player)
	enableStructure(powerGen, 0)
	enableStructure(oilDerrick, 0)
	enableStructure(research, 0)
	enableStructure(factory, 0)
	-- enableStructure(powerModuleHack, 0);
	-- no reinforcements yet!!
	setReinforcementTime(-1/10.0)
	-- set up resource coords (since oil pools diappear when built on!!!)
	-- res1x=res1.x;
	-- res1y=res1.y;
	-- add machine gun crate
	art1ID = addFeature(crate, art1X, art1Y)
	-- setEventTrigger(art1SeenEvnt, art1SeenTrig);
	conditionalEvent(art1TakeEvnt, "droidInRange(player, art1X, art1Y, 171)", 0.5)
	-- set up some AI for artifact pickup trigger
	-- rear 1 (jeeps)
	groupAddArea(enemy1Rear1, enemy1, 4928, 11072, 5184, 11712)
	-- move away at start so not seen!
	orderGroupLoc(enemy1Rear1, DORDER_SCOUT, 4800, 10432)
	deactivateEvent(startEvnt)
end
callbackEvent(startEvnt, CALL_VIDEO_QUIT)

function flightStart()
	addMessage(InFlight, MISS_MSG, 0, true)
	deactivateEvent(flightStart)
end
callbackEvent(flightStart, CALL_GAMEINIT)

-- Events:

-- Events: Artifacts
function art1TakeEvnt()
	numart = numart + 1
	-- playSound(art1Snd2, player);
	playSoundPos(art1Snd2, player, art1ID.x, art1ID.y, art1ID.z)
	destroyFeature(art1ID)
	-- removeMessage(art1Msg, PROX_MSG, player);
	removeMessage(obj1, PROX_MSG, player)
	enableResearch(art1Comp, player)
	-- grab all forces and order to follow player
	groupAddArea(enemy1Last, enemy1, 0, 0, 44 * 128, 93 * 128)
	-- order to fire at will
	-- fire at will
	setGroupSecondary(enemy1Last, DSO_ATTACK_LEVEL, DSS_ALEV_ALWAYS)
	groupAddArea(enemy1Last, enemy1, 0, 0, 44 * 128, 32 * 128)
	-- attack top
	orderGroupLoc(enemy1Last, DORDER_SCOUT, 2752, 2752)
	groupAddArea(enemy1Last1, enemy1, 0, 32 * 128, 44 * 128, 64 * 128)
	-- add stuff on hill west
	groupAddArea(enemy1Last1, enemy1, 576, 1216, 1472, 5056)
	-- attack mid
	orderGroupLoc(enemy1Last1, DORDER_SCOUT, 2496, 7460)
	groupAddArea(enemy1Last2, enemy1, 0, 64 * 128, 44 * 128, 93 * 128)
	-- add east side so attack bottom
	groupAddArea(enemy1Last2, enemy1, 4032, 576, 5312, 11584)
	-- attack bot
	orderGroupLoc(enemy1Last2, DORDER_SCOUT, 1856, 10432)
	
	
	--[[no longer req'd
	//place units
		addDroid(jeep,4696,9920,enemy1);
		addDroid(jeep,4696,10048,enemy1);
		addDroid(jeep,4568,9920,enemy1);
		addDroid(jeep,4568,10048,enemy1);]]--
	
	-- set retreat point
	-- retreat to LZ
	setRetreatPoint(enemy1, 1856, 10432)
	-- set morale to 10%
	setRetreatForce(enemy1, 90)
	-- set leadership chance (small=more likely?)
	setRetreatLeadership(enemy1, 50)
	-- make a force and block LZ!!!!
	groupAddArea(enemy1Surprise, enemy1, 4000, 9000, 6000, 11000)
	orderGroupLoc(enemy1Surprise, DORDER_SCOUT, 1856, 10432)
	-- add LZ blip and WAV message
	
	-- Add the proximity message only once
	addMessage(LZ_MSG, PROX_MSG, player, false)
	-- New function to periodically add the LZ message
	delayedEvent(periodicRTLZ, 0.0)
	-- addConsoleText(_("Return to LZ"), player);
	-- playSound(LZSnd, player);
	-- playSoundPos(LZSnd, player, 1216, 10816, 0);	//as in prox1-1.txt
	deactivateEvent(art1TakeEvnt)
end

function periodicRTLZ()
	showConsoleText(_("Return to LZ"), player)
	-- playSound(LZSnd, player);
	-- as in prox1-1.txt
	playSoundPos(LZSnd, player, 1216, 10816, 0)
	repeatingEvent(periodicRTLZ, 30.0)
end

-- Events: Win or Lose

-- assumes victory already checked
function nextLevEvnt()
	pause(20/10.0)
	-- give bonus research (if req'd)
	count = 0
	while count < numResP0 do
		enableResearch(resP0[count], 0)
		count = count + 1
	end
	
	-- flag next part of map
	C.gameLevel = C.gameLevel + 1
	-- setLandingZone(10, 51, 12, 53);
	enableResearch(art1Comp, player)
	-- removeMessage(MissionBrief, MISS_MSG, player);
	startMission(BETWEEN, NextLev)
	
	-- End game here for now! (don't try next mission)
	-- gameOver(true);
	
	deactivateEvent(nextLevEvnt)
end

function gameLost()
	gameOverMessage(endMsg, MISS_MSG, 0, false)
	deactivateEvent(gameLost)
end

function lostYetEvnt()
	if not anyDroidsLeft(player) then
		if not anyStructButWallsLeft(player) then
			deactivateEvent(wonYetLZEvnt)
			deactivateEvent(timeUp)
			-- waits 2 seconds before ending
			repeatingEvent(gameLost, 2.0)
			deactivateEvent(lostYetEvnt)
		end
	end
end
repeatingEvent(lostYetEvnt, 0.5)


-- out of time?
function timeUp()
	deactivateEvent(wonYetLZEvnt)
	deactivateEvent(lostYetEvnt)
	-- waits 2 seconds before ending
	repeatingEvent(gameLost, 2.0)
	deactivateEvent(timeUp)
end
callbackEvent(timeUp, CALL_MISSION_TIME)


-- got artifact yet?
function wonYetLZEvnt()
	totDroids = numDroidsInArea(player, 0, 0, 48 * 128, 96 * 128)
	-- if (totDroids == numDroidsInArea(player, 5*128, 80*128, 13*128, 86*128))
	if totDroids == numDroidsInArea(player, 704, 10048, 1984, 11328) then
		if totDroids ~= 0 then
			if numDroidsInArea(enemy1, 704, 10048, 1984, 11328) == 0 then
				deactivateEvent(lostYetEvnt)
				repeatingEvent(nextLevEvnt, 0.5)
				-- setEventTrigger(wonYetEvnt, inactive);
				deactivateEvent(wonYetLZEvnt)
			end
		end
	end
end
conditionalEvent(wonYetLZEvnt, "(numart == 1)", 0.6)

-- cheat button ctrl M
function cheatEvnt()
	repeatingEvent(nextLevEvnt, 0.5)
	deactivateEvent(cheatEvnt)
end
callbackEvent(cheatEvnt, CALL_MISSION_START)

-- Base Under Attack
function baseHit(_hitStruc, _attackerObj)
	if _hitStruc.player ~= C.selectedPlayer then return end
	hitStruc, attackerObj = _hitStruc, _attackerObj -- wz2lua: probably these can be used as function arguments directly
	if t >= 20 then
		t = 0
		if hitStruc ~= nil then
			playSoundPos(attackSnd1, C.selectedPlayer, hitStruc.x, hitStruc.y, hitStruc.z)
		else
			playSound(attackSnd1, C.selectedPlayer)
		end
	end
end
callbackEvent(baseHit, CALL_STRUCT_ATTACKED)

function everySec()
	t = t + 1
end
repeatingEvent(everySec, 1.0)

function seeBaseHit()
	if hitStruc ~= nil then
		centreView(hitStruc)
		-- flag known about!
		t = 0
	end
end
callbackEvent(seeBaseHit, CALL_MISSION_END)


---------- stubs ----------

if _ == nil then _ = function() print("stub: _"); return 0 end end
if gameOverMessage == nil then gameOverMessage = function() print("stub: gameOverMessage"); return 0 end end
if centreView == nil then centreView = function() print("stub: centreView"); return 0 end end
if anyStructButWallsLeft == nil then anyStructButWallsLeft = function() print("stub: anyStructButWallsLeft"); return 0 end end
if enableResearch == nil then enableResearch = function() print("stub: enableResearch"); return 0 end end
if flashOff == nil then flashOff = function() print("stub: flashOff"); return 0 end end
if addFeature == nil then addFeature = function() print("stub: addFeature"); return 0 end end
if setRetreatPoint == nil then setRetreatPoint = function() print("stub: setRetreatPoint"); return 0 end end
if orderGroupLoc == nil then orderGroupLoc = function() print("stub: orderGroupLoc"); return 0 end end
if anyDroidsLeft == nil then anyDroidsLeft = function() print("stub: anyDroidsLeft"); return 0 end end
if droidInRange == nil then droidInRange = function() print("stub: droidInRange"); return 0 end end
if setEventTrigger == nil then setEventTrigger = function() print("stub: setEventTrigger"); return 0 end end
if removeMessage == nil then removeMessage = function() print("stub: removeMessage"); return 0 end end
if destroyFeature == nil then destroyFeature = function() print("stub: destroyFeature"); return 0 end end
if setGroupSecondary == nil then setGroupSecondary = function() print("stub: setGroupSecondary"); return 0 end end
if setReinforcementTime == nil then setReinforcementTime = function() print("stub: setReinforcementTime"); return 0 end end
if setStructureLimits == nil then setStructureLimits = function() print("stub: setStructureLimits"); return 0 end end
if groupAddArea == nil then groupAddArea = function() print("stub: groupAddArea"); return 0 end end
if setLandingZone == nil then setLandingZone = function() print("stub: setLandingZone"); return 0 end end
if showConsoleText == nil then showConsoleText = function() print("stub: showConsoleText"); return 0 end end
if playSoundPos == nil then playSoundPos = function() print("stub: playSoundPos"); return 0 end end
if numDroidsInArea == nil then numDroidsInArea = function() print("stub: numDroidsInArea"); return 0 end end
if startMission == nil then startMission = function() print("stub: startMission"); return 0 end end
if pause == nil then pause = function() print("stub: pause"); return 0 end end
if setTransporterExit == nil then setTransporterExit = function() print("stub: setTransporterExit"); return 0 end end
if playSound == nil then playSound = function() print("stub: playSound"); return 0 end end
if setRetreatForce == nil then setRetreatForce = function() print("stub: setRetreatForce"); return 0 end end
if flyTransporterIn == nil then flyTransporterIn = function() print("stub: flyTransporterIn"); return 0 end end
if addMessage == nil then addMessage = function() print("stub: addMessage"); return 0 end end
if setRadarZoom == nil then setRadarZoom = function() print("stub: setRadarZoom"); return 0 end end
if setRetreatLeadership == nil then setRetreatLeadership = function() print("stub: setRetreatLeadership"); return 0 end end
if enableStructure == nil then enableStructure = function() print("stub: enableStructure"); return 0 end end
if centreViewPos == nil then centreViewPos = function() print("stub: centreViewPos"); return 0 end end
